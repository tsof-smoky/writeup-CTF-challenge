## Tools:

-   [BrimSecurity](https://www.brimsecurity.com/)
-   [suricatarunner](https://github.com/brimsec/build-suricata/releases/tag/v5.0.3-brim1)
-   [suricata.rules](https://download.cyberdefenders.org/BlueYard/misc/suricata.zip)
-   [NetworkMiner](https://www.netresec.com/?page=networkminer)
-   [WireShark](https://www.wireshark.org/)
-   [hybrid-analysis](https://www.hybrid-analysis.com/)

## SCENARIO

You're working as an analyst at a Security Operations Center (SOC) for a Thanksgiving-themed company. One quiet evening, you hear someone knocking at the SOC entrance.  As you answer the door, an exhausted mail server technician stumbles in and quickly falls to the floor.  He whispers in a shaky voice, "Mail filters are down...  Spam everywhere..."

As you help him up, he looks to the sky and yells, "The gates of hell have opened!"The technician immediately collapses again and softly whispers, "The horror...  The horror...".

The mail filter outage lasted throughout the next day.  Fortunately, very few incidents were reported.  But one example caught your eye. During the mail filter outage, one of the company employees decided to play "email roulette."  The employee opened one of the malicious emails from his inbox and treated it as a legitimate message.
 ![](https://www.malware-traffic-analysis.net/2015/11/06/2015-11-06-traffic-analysis-exercise-image-01.jpg)

## YOUR ASSIGNMENT

You acquired four malicious emails the employee received.  You also received a pcap of traffic from his infected computer.  Your task?  Figure out which email was used to compromise the system.

Thanks, [th3c0rt3x](https://cyberdefenders.org/profile/th3c0rt3x) for reviewing the challenge.

------------------------------------

1. c41-MTA5-email-01: What is the name of the malicious file?
I used this tool to extract all the attachments in the .eml files
[EML Attachment Extractor to Extract EML Attachments Mac & Windows OS (systoolsgroup.com)](https://www.systoolsgroup.com/eml/attachment-extractor/)

![Pasted image 20230330144031](https://user-images.githubusercontent.com/107832241/228798555-9da0b4f4-f78d-4eb2-8801-4d32626f8ef9.png)

![Pasted image 20230330144229](https://user-images.githubusercontent.com/107832241/228798622-cdb549a4-4f74-4dd4-b9bd-71ac3947d907.png)

>Answer: 460630672421.exe

2. c41-MTA5-email-01: What is the name of the trojan family the malware belongs to? (As identified by emerging threats ruleset).

You can upload directly to sandbox like [ANY.RUN](https://any.run/) or [hybrid-analysis](https://www.hybrid-analysis.com/)

Or Get-FileHash and upload to [VirusTotal](https://www.virustotal.com/gui/home/upload)
![Pasted image 20230330144941](https://user-images.githubusercontent.com/107832241/228798684-1f2651a4-42e4-47da-b9be-3517714418e8.png)

>Answer: UPATRE

3. c41-MTA5-email-01: The malware dropped two malicious files with the same hash but with different names. Provide the SHA256 hash of those files? (Check the report submitted in 2015).

The question asked us to check the report submitted in 2015. So go to [hybrid-analysis](https://www.hybrid-analysis.com/) with the hash we get from Q2. Note that we may not see the correct answer if we don't check the correct report.

![Pasted image 20230330145744](https://user-images.githubusercontent.com/107832241/228798733-39bcb4c4-1ce9-4476-9369-9a23afd4f67e.png)

>Answer: d1818c3fbbb1f09d8998ad44d14ee9a4fbfae5a1bb58128c2ac077a06d7f84b9

4. c41-MTA5-email-01: How many DNS requests were initiated by the malware? (Check the report submitted in 2015).

![Pasted image 20230330145822](https://user-images.githubusercontent.com/107832241/228798781-04c4f89a-29e1-44e4-81de-7f696dfd213e.png)

>Answer: 3

5. c41-MTA5-email-02: Multiple streams contain macros in this document. Provide the number of the highest one.

I used oletools to investigate macros. You can downloads and install they in the link below:
https://github.com/DidierStevens/DidierStevensSuite/blob/master/oledump.py
https://github.com/decalage2/oletools/releases

And again, extract document from the .eml file. 
![Pasted image 20230330150143](https://user-images.githubusercontent.com/107832241/228798833-c46d8629-78cb-444f-9ef0-5c99b18461d3.png)

I checked the document with oleid.py and confirm that the document has malicious macros.
![Pasted image 20230330150403](https://user-images.githubusercontent.com/107832241/228798873-503ca31c-e9ae-4cfd-898e-4a404835386d.png)

Then, I used oledump to dump all malicious macros to console.
![Pasted image 20230330150320](https://user-images.githubusercontent.com/107832241/228798910-2d05a916-b620-4e34-9293-69d3b81d4288.png)

>Answer: 20

6. c41-MTA5-email-02: The Excel macro tried to download a file. Provide the full URL of this file?

- **Sandbox:**
Get-FileHash of the document, and upload to [VirusTotal](https://www.virustotal.com/gui/home/upload)

![Pasted image 20230330150836](https://user-images.githubusercontent.com/107832241/228798952-ea0f5a51-3dda-4c9c-a0b6-63f244a140ea.png)

Below the tab RELATIONS, we can see the URLs that the Excel macro tried to download.

![Pasted image 20230330150815](https://user-images.githubusercontent.com/107832241/228798986-65971219-2a8c-47a9-81d9-4c49ba45bad4.png)

- **Manual analysis macro:**

![Pasted image 20230330154612](https://user-images.githubusercontent.com/107832241/228799026-b92efa6c-39cb-4ff6-9174-74e5040c857d.png)
From extracted macro script (by olevba.py), you can get the URLs by run command below:
```
valdis = [6340, 6352, 6352, 6348, 6294, 6283, 6283, 6333, 6336, 6354, 6333, 6346, 6335, 6337, 6336, 6339, 6350, 6347, 6353, 6348, 6282, 6346, 6337, 6352, 6282, 6333, 6353, 6283, 6362, 6341, 6346, 6335, 6333, 6346, 6352, 6341, 6346, 6283, 6287, 6287, 6288, 6339, 6289, 6342, 6291, 6290, 6283, 6292, 6293, 6291, 6341, 6291, 6353, 6356, 6349, 6337, 6282, 6337, 6356, 6337]
for n in range(0, len(valdis)): print(chr(valdis[n] - 4 * 59 - 6000), end="")
```

![Pasted image 20230330155006](https://user-images.githubusercontent.com/107832241/228799081-729de834-430f-48ef-ad67-409f57e2d0aa.png)

**Note**: *This solution is not mine. After finding the answer, I saw a hint from [CyberDefenders](https://cyberdefenders.org) and simulated it for practice*

>Answer: hxxp[://]advancedgroup[.]net[.]au/~incantin/334g5j76/897i7uxqe[.]exe

7. c41-MTA5-email-02: What is the name of the object used to get data from the download URL?

- **Google:**
I searched Google with the string  ```macro object get data from URL download``` and then this lead me to this page [Excel-VBA Solutions: Download a file from URL using VBA (excelvbasolutions.com)](https://www.excelvbasolutions.com/2014/09/download-file-from-url-using-vba.html)

Reading carefully, I find this interesting. Yea, it's exactly what the question asked for.
![Pasted image 20230330151836](https://user-images.githubusercontent.com/107832241/228799170-67f9198e-0f90-442d-ac95-656c6660a84f.png)

- **Manual analysis macro:**
We can see very first of the macro, ```zilibobe = "t"```
![Pasted image 20230330155631](https://user-images.githubusercontent.com/107832241/228799201-6434b63f-c47e-434d-af3d-5fd7ca707455.png)

Search next with this string, you can see the answer concealed
![Pasted image 20230330155830](https://user-images.githubusercontent.com/107832241/228799255-63804818-dde0-4605-b24f-c4e1078cd26e.png)

**Note**: *This solution is not mine. After finding the answer, I saw a hint from [CyberDefenders](https://cyberdefenders.org) and simulated it for practice*

>Answer: Microsoft.XMLHTTP

8. c41-MTA5-email-02: The Excel macro writes a file to the temp folder. Provide the filename?

- **Sandbox**:
Back to [VirusTotal](https://www.virustotal.com/gui/home/upload), with <kbd>Ctrl</kbd> +<kbd>F</kbd>  and key word is ```temp```, you can see it immediately.
![Pasted image 20230330152113](https://user-images.githubusercontent.com/107832241/228799333-1e1698b6-dfa3-43a4-a7ce-2cc04e5b0cfa.png)

- **Manual analysis macro:**

Yes, still it, our great clue
![Pasted image 20230330160012](https://user-images.githubusercontent.com/107832241/228799404-c4f147f6-30a1-44a3-913d-4538d15e7cb7.png)

**Note**: *This solution is not mine. After finding the answer, I saw a hint from [CyberDefenders](https://cyberdefenders.org) and simulated it for practice*

>Answer: tghtop.exe

9. c41-MTA5-email-03: Provide the FQDN used by the attacker to store the login credentials?

Still extract attachment from .eml. I got a .html file and then, just viewsource of this file.
![Pasted image 20230330160214](https://user-images.githubusercontent.com/107832241/228799441-db546e7e-68f8-40ba-9446-e86f6ab84c8d.png)

>Answer: jpmmotos.pt

10. c41-MTA5-email-04: How many FQDNs are present in the malicious js?

After extracting, I had this file. The attacker frauded the user by the ext **doc**. 
![Pasted image 20230330160622](https://user-images.githubusercontent.com/107832241/228799509-589425a1-d398-4af1-b164-155421794d0e.png)

Editing it, I had this messy file
![Pasted image 20230330160845](https://user-images.githubusercontent.com/107832241/228799520-c7b23229-f4f2-494f-b92d-05235379da70.png)

Easy beautiful this code with https://jsbeautify.org/. After that, I changed the code to Python with a little bit change at the end of file by print variable "u7".
![Pasted image 20230330161148](https://user-images.githubusercontent.com/107832241/228799534-4f2339cc-0de6-4a9c-a5ec-5cceafb6ba17.png)
Don't worry, cause I made the code easier to see. By the way, we have 3 FQDNs here.

>Answer: 3

11. c41-MTA5-email-04: What is the name of the object used to handle and read files?

>Answer: ADODB.Stream

12. c41-MTA5.pcap: The victim received multiple emails; however, the user opened a single attachment. Provide the attachment filename.

Since the user has opened a malicious attachment, so obviously there will be suspiciousness stored in the pcap file. I tried with the domains found above, and one of them was correct.
![Pasted image 20230330162101](https://user-images.githubusercontent.com/107832241/228799796-0819cd15-be15-47d7-b2ac-a529f37ce2a1.png)

>Answer: fax000497762.zip

13. c41-MTA5.pcap: What is the IP address of the victim machine?

>Answer: 10.3.66.103

14. c41-MTA5.pcap: What is the hostname of the victim machine?

Filter wireshark with the ip above.
![Pasted image 20230330162557](https://user-images.githubusercontent.com/107832241/228799869-ec921be0-41d5-4dd1-9c54-ede125b54051.png)

>Answer: Strout-PC 

15. c41-MTA5.pcap: What is the FQDN that hosted the malware?

>Answer: kennedy.sitoserver.com

16. c41-MTA5.pcap: The opened attachment wrote multiple files to the TEMP folder. Provide the name of the first file written to the disk?

- **Sandbox:**
[Automated Malware Analysis Report for fax000497762.doc.js - Generated by Joe Sandbox](https://www.joesandbox.com/analysis/547318/0/html)
![Pasted image 20230330163028](https://user-images.githubusercontent.com/107832241/228799911-c6abae94-9e86-451b-a459-7f150db90741.png)

- **Manual analysis:**
![Pasted image 20230330162858](https://user-images.githubusercontent.com/107832241/228799923-095dfd66-6319-488f-928b-b4ee0d9f6d0d.png)

>Answer: 7997551.exe

17. c41-MTA5.pcap: One of the written files to the disk has the following md5 hash "35a09d67bee10c6aff48826717680c1c"; Which registry key does this malware check for its existence?

Extracting files from malicious FQDN and compute MD5 hash.
![Pasted image 20230330163236](https://user-images.githubusercontent.com/107832241/228800006-da341432-a8cc-4448-82cc-5ad4bd37b08c.png)

Take a long time with the sandbox and is inefficient. I tried running it by myself.
Load the file to x32dbg and set ```bp RegOpenKeyA```. After that, run programs with the breakpoint, I got the interface with the answer.
![Pasted image 20230330163646](https://user-images.githubusercontent.com/107832241/228800016-782f625f-af42-406a-b6a3-93fb9339add2.png)

>Answer: 9a83a958-b859-11d1-aa90-00aa00ba3258

18. c41-MTA5.pcap: One of the written files to the disk has the following md5 hash "e2fc96114e61288fc413118327c76d93" sent an HTTP post request to "upload.php" page. Provide the webserver IP. (IP is not in PCAP)

Upload the hash to [VirusTotal](https://www.virustotal.com/gui/home/upload) and get the answer.
![Pasted image 20230330164211](https://user-images.githubusercontent.com/107832241/228800098-551a215c-0589-4a3f-96b7-a2f240de44fa.png)

>Answer: 78.24.220.229

19. c41-MTA5.pcap: The malware initiated callback traffic after the infection. Provide the IP of the destination server.

```
event_type=="alert" alert.signature!="ET POLICY DNS Query to DynDNS Domain *.ddns .net" src_ip!=174.121.246.162 dest_ip!=174.121.246.162 | cut ts, src_ip, dest_ip, alert.signature | sort ts
```
![Pasted image 20230330164437](https://user-images.githubusercontent.com/107832241/228800118-e0a65388-a337-4228-a33f-c6f7c63b9c67.png)
Since I knew the ip of "kennedy.sitoserver.com" is "174.121.246.162", I skipped it and filter with Suricata alert.

>Answer: 109.68.191.31


Thanks [CyberDefenders](https://cyberdefenders.org) so much for this fun and difficult challenge.