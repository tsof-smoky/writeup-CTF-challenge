![Pasted image 20220621102223](https://user-images.githubusercontent.com/107832241/179939828-7006d262-a73a-4281-8ba6-dbdb57c8700e.png)

The attached PCAP belongs to an Exploitation Kit infection. Analyze it using your favorite tool and answer the challenge questions.

**Tools:**

-   [BrimSecurity](https://www.brimsecurity.com/)
-   [suricatarunner](https://github.com/brimsec/build-suricata/releases/tag/v5.0.3-brim1)
-   [suricata.rules](https://download.cyberdefenders.org/BlueYard/misc/suricata.zip)
-   [NetworkMiner](https://www.netresec.com/?page=networkminer)
-   [WireShark](https://www.wireshark.org/)

---

1. What is the IP address of the Windows VM that gets infected?

After downloading and decompressing, I have a pcap file as shown below:

![Pasted image 20220621104228](https://user-images.githubusercontent.com/107832241/179939688-de344637-4f6e-4a47-a28e-f07eb77a61af.png)

Importing the pcap file into Brim and WireShark, we will realize some exciting things:
![Pasted image 20220621104540](https://user-images.githubusercontent.com/107832241/179939905-2fa2fd52-f2d5-42d8-839a-efbef0f9e1e9.png)
![Pasted image 20220621104646](https://user-images.githubusercontent.com/107832241/179939984-dcdafa5e-53d0-4dad-a46e-e9bca3fa68f7.png)
Pivot to logs:
![Pasted image 20220621110615](https://user-images.githubusercontent.com/107832241/179940080-07436c91-efc0-4b7d-86f8-7fdf6cea315a.png)

More information: [Suricata_rules](https://github.com/OISF/suricata-update/blob/0a8fddd331d744c853e49001e50757bab702bad0/tests/emerging-current_events.rules#L2661)
Packet details:
![Pasted image 20220621110419](https://user-images.githubusercontent.com/107832241/179940175-d789159b-bef8-439b-a818-a527331dd177.png)

>Answer: 172.16.165.165

---

2. What is the hostname of the Windows VM that gets infected?

From Wireshark, filter by protocol ***DHCP*** and go to DHCP Request, we will find the answer in the data section.

![Pasted image 20220621104950](https://user-images.githubusercontent.com/107832241/179940245-9c0780f7-c558-4a0b-bb04-f200ef3071b5.png)


>Answer: K34EN6W3N-PC

---

3. What is the MAC address of the infected VM?

Similar to the above, we will also easily find out the device's MAC address:

![Pasted image 20220621105230](https://user-images.githubusercontent.com/107832241/179940330-f361ff34-5fa7-4daf-91a4-863c62c439cc.png)

>Answer: f0:19:af:02:9b:f1

---

4. What is the IP address of the compromised website?

Now that I have the IP of the infected machine, I will find information about ***HTTP***:
```
_path=="http" id.orig_h==172.16.165.165 | count() by host, id.resp_h
```
![Pasted image 20220621111345](https://user-images.githubusercontent.com/107832241/179940557-75d98e2b-7280-4e10-9412-c218d1d54540.png)

Then I filter for valuable information about links to suspicious websites:
```
_path=="http" id.orig_h==172.16.165.165 | cut id.orig_h, id.resp_h, host, method, referrer, ts, resp_mime_types | sort ts
```

![Pasted image 20220621111901](https://user-images.githubusercontent.com/107832241/179940621-47a5a001-3f39-4e62-9f58-32166ca29763.png)

On the first event, the victim machine searched for ciniholland[.]nl on the Bing search engine:

![Pasted image 20220621112130](https://user-images.githubusercontent.com/107832241/179940695-59c797a0-3a64-4b2f-83da-421ac5f6b5c1.png)

The victim machine is then redirected to ciniholland[.]nl via another website adultbiz[.]in

![Pasted image 20220621112349](https://user-images.githubusercontent.com/107832241/179940789-f6e89b4d-1550-4eec-949c-40470fcec7a1.png)

The victim machine continues to be redirected to ciniholland[.]nl through another website, 24corp-shop[.]com

![Pasted image 20220621112643](https://user-images.githubusercontent.com/107832241/179940860-957e1eea-be9b-45d3-a8cd-470d9cea562d.png)


Finally, the victim machine accesses stand[.]trustandprobaterealty[.]com through the website 24corp-shop[.]com

![Pasted image 20220621112905](https://user-images.githubusercontent.com/107832241/179940921-dd402422-b933-4933-a916-4c902473b782.png)

We can summarize the infection process as follows:
![Pasted image 20220621114303](https://user-images.githubusercontent.com/107832241/179940980-c59899d3-be13-466d-b761-ad9cc947a9a6.png)

>Answer: 82.150.140.30

---

5. What is the FQDN of the compromised website?

>Answer: ciniholland.nl

---

6. What is the IP address of the server that delivered the exploit kit and malware?

We will test Suricata's query - **Suricata Alerts by Category**
```
event_type=="alert" | alerts := union(alert.category) by src_ip, dest_ip
```
![Pasted image 20220621114413](https://user-images.githubusercontent.com/107832241/179941096-77c2a520-eb45-4a74-9549-b9c064aad5ed.png)

Pivot to logs:
```
src_ip==37.200.69.143 dest_ip==172.16.165.165 | cut event_type,src_ip,dest_ip,alert.severity, alert.signature,alert.category | sort ts
```
![Pasted image 20220621114927](https://user-images.githubusercontent.com/107832241/179941176-2502057c-c038-41ff-865c-b93a87feb947.png)

![Pasted image 20220621115220](https://user-images.githubusercontent.com/107832241/179941225-08c2cbd9-acf9-4941-a5b7-ed7d862e4f80.png)

>Answer: 37.200.69.143

---

7. What is the FQDN that delivered the exploit kit and malware?


>Answer: stand.trustandprobaterealty.com

---

8. What is the redirect URL that points to the exploit kit (EK) landing page?

>Answer:  http://24corp-shop[.]com/

---

9. Other than CVE-2013-2551 IE exploit, another application was targeted by the EK and starts with "J". Provide the full application name.

```
event_type=="alert" | count() by alert.signature | sort -r
```
![Pasted image 20220621115433](https://user-images.githubusercontent.com/107832241/179941348-b6f43f95-40b9-4370-bd78-40d71bcbd40a.png)

>Answer: Java

---

10. How many times was the payload delivered?


![Pasted image 20220621115627](https://user-images.githubusercontent.com/107832241/179941422-b53578f9-33db-40d1-919d-3528a289c343.png)

>Answer: 3

---

12. The compromised website has a malicious script with a URL. What is this URL?

```
_path=="http" host=="www.ciniholland.nl" | sort ts
```
![Pasted image 20220621120032](https://user-images.githubusercontent.com/107832241/179941480-09ce6306-ecc5-481d-bb1f-51a65cca05fa.png)

Select the first packet and in the top right corner will appear the icon of WireShark, select to open the packet details:
![Pasted image 20220621120216](https://user-images.githubusercontent.com/107832241/179941555-e417f95f-77e0-41dd-94a3-29054f2352ce.png)

Follow TCP Stream:
![Pasted image 20220621115946](https://user-images.githubusercontent.com/107832241/179941616-a7b18305-aba6-4874-8005-8ddf30f182e5.png)

Above we can see that the malicious website contains a malicious script containing the URL that navigates to 24corp-shop[.]com, the attribute is ***visibility:hidden***
![Pasted image 20220621120607](https://user-images.githubusercontent.com/107832241/179941694-b93c4964-9924-405e-a089-fcd8da3c5bdb.png)

>Answer: http://24corp-shop[.]com/

---

13. Extract the two exploit files. What are the MD5 file hashes? (comma-separated )
```
_path=="files" source=="HTTP" 37.200.69.143 in tx_hosts | cut tx_hosts, rx_hosts, md5, mime_type
```
![Pasted image 20220621120756](https://user-images.githubusercontent.com/107832241/179941831-5947374d-ac33-49ce-98f4-6fe8717b885a.png)

![Pasted image 20220621120911](https://user-images.githubusercontent.com/107832241/179941894-3545bb5e-8b4c-4096-8e76-73c3b623c104.png)

![Pasted image 20220621120939](https://user-images.githubusercontent.com/107832241/179941956-09bf77df-b166-4b42-bf83-9e5aac11a2d4.png)

>Answer: 7b3baa7d6bb3720f369219789e38d6ab,1e34fdebbf655cebea78b45e43520ddf

![Pasted image 20220621121144](https://user-images.githubusercontent.com/107832241/179941994-76679fa6-d326-4606-bd5f-58479cc30afe.png)

I wish you a good day!

